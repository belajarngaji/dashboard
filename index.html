<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Kuis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #111827;
            color: #d1d5db;
            font-family: 'Inter', sans-serif;
        }
        .kpi-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        @import url('https://rsms.me/inter/inter.css');
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-gray-800 shadow-md p-4">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                Dashboard Admin Kuis
            </h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto">
        <div id="loading-state" class="text-center py-20">
            <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-gray-400">Memuat data dari Supabase...</p>
        </div>
        <div id="error-state" class="hidden text-center py-20 bg-red-900/20 border border-red-500 rounded-lg">
             <h2 class="mt-4 text-2xl font-bold text-red-300">Gagal Terhubung</h2>
             <p class="mt-2 text-red-400">Pastikan URL dan Anon Key Supabase sudah benar.</p>
        </div>
        <div id="main-content" class="hidden">
            <!-- KPI Cards -->
            <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Total Pengguna</h3>
                    <p id="total-users" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Pengguna Baru (7 Hari)</h3>
                    <p id="new-users" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Kuis Dikerjakan Hari Ini</h3>
                    <p id="quiz-attempts-today" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
            </section>

            <!-- Charts -->
            <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <div class="lg:col-span-3 bg-gray-800 border border-gray-700 rounded-lg p-6 h-96">
                    <h3 class="font-semibold text-white mb-4">Grafik Pendaftaran Pengguna (7 Hari Terakhir)</h3>
                    <div class="relative h-full w-full">
                       <canvas id="user-registration-chart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-6 h-96">
                    <h3 class="font-semibold text-white mb-4">Kuis Terpopuler</h3>
                    <div class="relative h-full w-full flex items-center justify-center">
                        <canvas id="popular-quizzes-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Recent Activities Table -->
            <section>
                <h3 class="text-xl font-semibold text-white mb-4">Aktivitas Terbaru</h3>
                <div class="bg-gray-800 border border-gray-700 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Pengguna</th>
                                    <th scope="col" class="py-3 px-6">Nama Kuis</th>
                                    <th scope="col" class="py-3 px-6">Skor</th>
                                    <th scope="col" class="py-3 px-6">Waktu</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activity-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- REVISI KESELURUHAN PADA SCRIPT -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- KONFIGURASI SUPABASE ANDA ---
        const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE";
        
        // --- Inisialisasi Supabase Client ---
        let supabase;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Error initializing Supabase:", error);
        }
        
        // --- FUNGSI-FUNGSI PENGAMBIL DATA ---

        // Mengambil jumlah total pengguna dari tabel 'profiles'
        async function fetchTotalUsers() {
            // REVISI: Menggunakan tabel 'profiles'
            const { count, error } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true });
            if (error) console.error('Error fetching total users:', error.message);
            return count || 0;
        }

        // Mengambil pengguna baru (dari 'profiles') dalam 7 hari terakhir
        async function fetchNewUsersLast7Days() {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            // REVISI: Menggunakan tabel 'profiles'
            const { count, error } = await supabase
                .from('profiles')
                .select('created_at', { count: 'exact', head: true })
                .gte('created_at', sevenDaysAgo);
            if (error) console.error('Error fetching new users:', error.message);
            return count || 0;
        }

        // Mengambil pengerjaan kuis hari ini dari 'quiz_attempts'
        async function fetchQuizAttemptsToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            // REVISI: Menggunakan 'quiz_attempts' dan kolom 'submitted_at'
            const { count, error } = await supabase
                .from('quiz_attempts')
                .select('*', { count: 'exact', head: true })
                .gte('submitted_at', today.toISOString());
            if (error) console.error('Error fetching quiz attempts:', error.message);
            return count || 0;
        }

        // Mengambil data untuk chart pendaftaran pengguna (dari 'profiles')
        async function fetchUserRegistrationData() {
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                labels.push(date.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }));

                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);

                // REVISI: Menggunakan tabel 'profiles'
                const { count } = await supabase
                    .from('profiles')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', startOfDay.toISOString())
                    .lte('created_at', endOfDay.toISOString());
                data.push(count || 0);
            }
            return { labels, data };
        }

        // Mengambil data kuis terpopuler dari 'quiz_attempts'
        async function fetchPopularQuizzes() {
            // REVISI: Menggunakan 'quiz_attempts' dan kolom 'quiz_id'
            const { data, error } = await supabase.from('quiz_attempts').select('quiz_id');
            if (error) {
                console.error('Error fetching popular quizzes:', error.message);
                return { labels: [], data: [] };
            }

            const quizCounts = data.reduce((acc, item) => {
                const quizName = item.quiz_id.replace(/_/g, ' ').replace('kelas01 bab01 ', ''); // Membersihkan nama kuis
                acc[quizName] = (acc[quizName] || 0) + 1;
                return acc;
            }, {});

            const sortedQuizzes = Object.entries(quizCounts).sort(([,a],[,b]) => b-a).slice(0, 5);
            return {
                labels: sortedQuizzes.map(item => item[0]),
                data: sortedQuizzes.map(item => item[1]),
            };
        }

        // Mengambil aktivitas terbaru dari 'quiz_attempts' dan menggabungkannya dengan 'profiles'
        async function fetchRecentActivities() {
            // REVISI: Query disesuaikan dengan skema Anda
            const { data, error } = await supabase
                .from('quiz_attempts')
                .select(`
                    submitted_at,
                    score,
                    quiz_id,
                    profiles ( username ) 
                `)
                .order('submitted_at', { ascending: false })
                .limit(5);
            if(error) console.error('Error fetching recent activities:', error.message);
            return data || [];
        }

        // Fungsi utilitas untuk membuat chart
        function createChart(ctx, type, labels, data, label, backgroundColor, borderColor) {
             new Chart(ctx, { type, data: { labels, datasets: [{ label, data, backgroundColor, borderColor, borderWidth: type === 'doughnut' ? 0 : 1, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
        }

        // --- INISIALISASI HALAMAN ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!supabase) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                return;
            }

            const [
                totalUsers, newUsers, attemptsToday,
                userChartData, popularQuizData, recentActivities
            ] = await Promise.all([
                fetchTotalUsers(), fetchNewUsersLast7Days(), fetchQuizAttemptsToday(),
                fetchUserRegistrationData(), fetchPopularQuizzes(), fetchRecentActivities()
            ]);

            // Update KPI Cards
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('new-users').textContent = newUsers;
            document.getElementById('quiz-attempts-today').textContent = attemptsToday;

            // Render Charts
            const userCtx = document.getElementById('user-registration-chart').getContext('2d');
            createChart(userCtx, 'line', userChartData.labels, userChartData.data, 'Pengguna Baru', 'rgba(59, 130, 246, 0.2)', '#3b82f6');
            const quizCtx = document.getElementById('popular-quizzes-chart').getContext('2d');
            createChart(quizCtx, 'doughnut', popularQuizData.labels, popularQuizData.data, 'Pengerjaan', ['#10b981', '#3b82f6', '#ef4444', '#f97316', '#8b5cf6'], '#1f2937');
            
            // Render Recent Activities Table
            const activityTable = document.getElementById('recent-activity-body');
            if (recentActivities.length > 0) {
                 activityTable.innerHTML = recentActivities.map(act => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="py-4 px-6">${act.profiles?.username || 'Tanpa Nama'}</td>
                        <td class="py-4 px-6 capitalize">${act.quiz_id.replace(/_/g, ' ')}</td>
                        <td class="py-4 px-6 font-medium text-emerald-400">${act.score}</td>
                        <td class="py-4 px-6 text-sm text-gray-400">${new Date(act.submitted_at).toLocaleString('id-ID')}</td>
                    </tr>
                `).join('');
            } else {
                 activityTable.innerHTML = `<tr><td colspan="4" class="py-4 px-6 text-center text-gray-400">Belum ada aktivitas.</td></tr>`;
            }

            // Tampilkan konten utama
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });
    </script>
</body>
</html>