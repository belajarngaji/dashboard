<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Kuis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- PENTING: KONFIGURASI SUPABASE ANDA ---
        // Ganti dengan URL dan Anon Key dari proyek Supabase Anda.
        // Anda bisa menemukannya di Pengaturan Proyek > API.
        const SUPABASE_URL = 'URL_SUPABASE_ANDA'; 
        const SUPABASE_ANON_KEY = 'ANON_KEY_SUPABASE_ANDA';
        // ---------------------------------------------

        // Inisialisasi Supabase Client
        let supabase;
        try {
            if (!SUPABASE_URL.includes('URL_SUPABASE_ANDA')) {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (error) {
            console.error("Error initializing Supabase:", error);
        }

        // Fungsi untuk mengambil jumlah total pengguna
        async function fetchTotalUsers() {
            const { data, error, count } = await supabase
                .from('users')
                .select('*', { count: 'exact', head: true });
            
            if (error) {
                console.error('Error fetching total users:', error.message);
                return 0;
            }
            return count;
        }

        // Fungsi untuk mengambil pengguna baru dalam 7 hari terakhir
        async function fetchNewUsersLast7Days() {
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const { data, error, count } = await supabase
                .from('users')
                .select('created_at', { count: 'exact', head: true })
                .gte('created_at', sevenDaysAgo);

            if (error) {
                console.error('Error fetching new users:', error.message);
                return 0;
            }
            return count;
        }

        // Fungsi untuk mengambil data pengerjaan kuis hari ini
        // Asumsi: Anda memiliki tabel bernama 'quiz_results' dengan kolom 'created_at'
        async function fetchQuizAttemptsToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayISO = today.toISOString();

            const { data, error, count } = await supabase
                .from('quiz_results') // GANTI NAMA TABEL JIKA PERLU
                .select('*', { count: 'exact', head: true })
                .gte('created_at', todayISO);

            if (error) {
                console.error('Error fetching quiz attempts today:', error.message, "(Mungkin tabel 'quiz_results' tidak ada atau nama kolom salah)");
                return 0;
            }
            return count;
        }

        // Fungsi untuk mengambil data untuk chart pendaftaran pengguna
        async function fetchUserRegistrationData() {
            const dates = [];
            const counts = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                dates.push(date.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }));

                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);

                const { count } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', startOfDay.toISOString())
                    .lte('created_at', endOfDay.toISOString());
                
                counts.push(count || 0);
            }
            return { labels: dates, data: counts };
        }
        
        // Fungsi untuk mengambil data kuis paling populer
        // Asumsi: tabel 'quiz_results' punya kolom 'quiz_name'
        async function fetchPopularQuizzes() {
            const { data, error } = await supabase
                .from('quiz_results') // GANTI NAMA TABEL JIKA PERLU
                .select('quiz_name'); // GANTI NAMA KOLOM JIKA PERLU

            if (error) {
                console.error('Error fetching popular quizzes:', error.message);
                return { labels: [], data: [] };
            }

            const quizCounts = data.reduce((acc, item) => {
                acc[item.quiz_name] = (acc[item.quiz_name] || 0) + 1;
                return acc;
            }, {});

            const sortedQuizzes = Object.entries(quizCounts)
                .sort(([,a],[,b]) => b-a)
                .slice(0, 5); // Ambil top 5

            return {
                labels: sortedQuizzes.map(item => item[0]),
                data: sortedQuizzes.map(item => item[1]),
            };
        }

        // Fungsi untuk mengambil aktivitas terbaru
        // Asumsi: Anda memiliki tabel 'profiles' yang terhubung dengan 'users' via 'id'
        async function fetchRecentActivities() {
            const { data, error } = await supabase
                .from('quiz_results') // GANTI NAMA TABEL JIKA PERLU
                .select(`
                    created_at,
                    score,
                    quiz_name,
                    user_id,
                    profiles ( username ) 
                `) // GANTI NAMA TABEL & KOLOM JIKA PERLU
                .order('created_at', { ascending: false })
                .limit(5);

            if(error) {
                console.error('Error fetching recent activities:', error.message);
                return [];
            }
            return data;
        }

        // Render chart
        function createChart(ctx, type, labels, data, label, backgroundColor, borderColor) {
            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d1d5db'
                            }
                        }
                    }
                }
            });
        }

        // Event listener saat halaman dimuat
        document.addEventListener('DOMContentLoaded', async () => {
            if (!supabase) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                return;
            }

            const [
                totalUsers, 
                newUsers, 
                attemptsToday,
                userChartData,
                popularQuizData,
                recentActivities
            ] = await Promise.all([
                fetchTotalUsers(),
                fetchNewUsersLast7Days(),
                fetchQuizAttemptsToday(),
                fetchUserRegistrationData(),
                fetchPopularQuizzes(),
                fetchRecentActivities()
            ]);

            // Update KPI Cards
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('new-users').textContent = newUsers;
            document.getElementById('quiz-attempts-today').textContent = attemptsToday;

            // Render Charts
            const userCtx = document.getElementById('user-registration-chart').getContext('2d');
            createChart(userCtx, 'line', userChartData.labels, userChartData.data, 'Pengguna Baru', 'rgba(59, 130, 246, 0.2)', 'rgba(59, 130, 246, 1)');

            const quizCtx = document.getElementById('popular-quizzes-chart').getContext('2d');
            createChart(quizCtx, 'doughnut', popularQuizData.labels, popularQuizData.data, 'Pengerjaan', 
                ['#10b981', '#3b82f6', '#ef4444', '#f97316', '#8b5cf6'],
                ['#1f2937']
            );
            
            // Render Recent Activities Table
            const activityTable = document.getElementById('recent-activity-body');
            if (recentActivities.length === 0) {
                activityTable.innerHTML = `<tr><td colspan="4" class="py-4 px-6 text-center text-gray-400">Belum ada aktivitas.</td></tr>`;
            } else {
                activityTable.innerHTML = recentActivities.map(activity => `
                    <tr class="border-b border-gray-700">
                        <td class="py-4 px-6">${activity.profiles?.username || 'Tanpa Nama'}</td>
                        <td class="py-4 px-6">${activity.quiz_name}</td>
                        <td class="py-4 px-6 font-medium text-emerald-400">${activity.score}</td>
                        <td class="py-4 px-6 text-sm text-gray-400">${new Date(activity.created_at).toLocaleString('id-ID')}</td>
                    </tr>
                `).join('');
            }


            // Sembunyikan loading state dan tampilkan konten
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });

    </script>
    <style>
        body {
            background-color: #111827;
            color: #d1d5db;
            font-family: 'Inter', sans-serif;
        }
        .kpi-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        @import url('https://rsms.me/inter/inter.css');
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-gray-800 shadow-md p-4">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                Dashboard Admin Kuis
            </h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto">
        
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20">
            <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-gray-400">Memuat data dari Supabase...</p>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20 bg-red-900/20 border border-red-500 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-400"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            <h2 class="mt-4 text-2xl font-bold text-red-300">Gagal Terhubung ke Supabase</h2>
            <p class="mt-2 text-red-400">Pastikan Anda telah memasukkan <strong>URL</strong> dan <strong>Anon Key</strong> Supabase yang benar di dalam file HTML.</p>
        </div>

        <div id="main-content" class="hidden">
            <!-- KPI Cards -->
            <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Total Users Card -->
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Total Pengguna</h3>
                    <p id="total-users" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
                <!-- New Users Card -->
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Pengguna Baru (7 Hari)</h3>
                    <p id="new-users" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
                <!-- Quiz Attempts Today Card -->
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Kuis Dikerjakan Hari Ini</h3>
                    <p id="quiz-attempts-today" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
            </section>

            <!-- Charts -->
            <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <div class="lg:col-span-3 bg-gray-800 border border-gray-700 rounded-lg p-6 h-96">
                    <h3 class="font-semibold text-white mb-4">Grafik Pendaftaran Pengguna (7 Hari Terakhir)</h3>
                    <div class="relative h-full w-full">
                       <canvas id="user-registration-chart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-6 h-96">
                    <h3 class="font-semibold text-white mb-4">Kuis Terpopuler</h3>
                    <div class="relative h-full w-full flex items-center justify-center">
                        <canvas id="popular-quizzes-chart"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Recent Activities Table -->
            <section>
                <h3 class="text-xl font-semibold text-white mb-4">Aktivitas Terbaru</h3>
                <div class="bg-gray-800 border border-gray-700 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Pengguna</th>
                                    <th scope="col" class="py-3 px-6">Nama Kuis</th>
                                    <th scope="col" class="py-3 px-6">Skor</th>
                                    <th scope="col" class="py-3 px-6">Waktu</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activity-body">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </div>
    </main>
</body>
</html>